<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
        http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.8.xsd">

    <!-- 
        NHIE Transaction Logging Table
        Purpose: Track all NHIE API interactions for audit, retry logic, and debugging
        Reference: AGENTS.md lines 763-783, docs/specs/queue-retry-policy.md
    -->
    <changeSet id="ghanaemr-nhie-transaction-log-1" author="ghana-emr">
        <comment>Create NHIE transaction log table for tracking all NHIE API calls</comment>
        
        <createTable tableName="ghanaemr_nhie_transaction_log">
            <!-- Primary Key -->
            <column name="id" type="BIGINT" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            
            <!-- Transaction Identification -->
            <column name="transaction_id" type="VARCHAR(36)">
                <constraints nullable="false" unique="true"/>
            </column>
            
            <!-- Patient Reference (FK to patient table) -->
            <column name="patient_id" type="INT">
                <constraints nullable="true" 
                             foreignKeyName="fk_nhie_txn_patient"
                             referencedTableName="patient"
                             referencedColumnNames="patient_id"/>
            </column>
            
            <!-- Encounter Reference (FK to encounter table) - optional for patient-only submissions -->
            <column name="encounter_id" type="INT">
                <constraints nullable="true"
                             foreignKeyName="fk_nhie_txn_encounter"
                             referencedTableName="encounter"
                             referencedColumnNames="encounter_id"/>
            </column>
            
            <!-- FHIR Resource Type -->
            <column name="resource_type" type="VARCHAR(50)">
                <constraints nullable="false"/>
            </column>
            
            <!-- HTTP Method -->
            <column name="http_method" type="VARCHAR(10)">
                <constraints nullable="false"/>
            </column>
            
            <!-- NHIE Endpoint URL -->
            <column name="endpoint" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            
            <!-- Request/Response Data (masked for PII) -->
            <column name="request_body" type="TEXT">
                <constraints nullable="true"/>
            </column>
            
            <column name="response_status" type="INT">
                <constraints nullable="true"/>
            </column>
            
            <column name="response_body" type="TEXT">
                <constraints nullable="true"/>
            </column>
            
            <!-- Retry Logic -->
            <column name="retry_count" type="INT" defaultValueNumeric="0">
                <constraints nullable="false"/>
            </column>
            
            <!-- Transaction Status -->
            <column name="status" type="VARCHAR(20)">
                <constraints nullable="false"/>
            </column>
            
            <!-- Error Details -->
            <column name="error_message" type="TEXT">
                <constraints nullable="true"/>
            </column>
            
            <!-- NHIE Patient/Encounter ID (returned from NHIE) -->
            <column name="nhie_resource_id" type="VARCHAR(255)">
                <constraints nullable="true"/>
            </column>
            
            <!-- Timestamps -->
            <column name="created_at" type="DATETIME">
                <constraints nullable="false"/>
            </column>
            
            <column name="updated_at" type="DATETIME">
                <constraints nullable="false"/>
            </column>
            
            <!-- Next Retry Time (for retry scheduler) -->
            <column name="next_retry_at" type="DATETIME">
                <constraints nullable="true"/>
            </column>
            
            <!-- User who initiated the transaction -->
            <column name="creator" type="INT">
                <constraints nullable="false"
                             foreignKeyName="fk_nhie_txn_creator"
                             referencedTableName="users"
                             referencedColumnNames="user_id"/>
            </column>
        </createTable>
        
        <!-- Indexes for Performance -->
        <createIndex tableName="ghanaemr_nhie_transaction_log" indexName="idx_nhie_txn_patient_id">
            <column name="patient_id"/>
        </createIndex>
        
        <createIndex tableName="ghanaemr_nhie_transaction_log" indexName="idx_nhie_txn_encounter_id">
            <column name="encounter_id"/>
        </createIndex>
        
        <createIndex tableName="ghanaemr_nhie_transaction_log" indexName="idx_nhie_txn_status">
            <column name="status"/>
        </createIndex>
        
        <createIndex tableName="ghanaemr_nhie_transaction_log" indexName="idx_nhie_txn_created_at">
            <column name="created_at"/>
        </createIndex>
        
        <!-- Composite index for retry queue queries -->
        <createIndex tableName="ghanaemr_nhie_transaction_log" indexName="idx_nhie_txn_retry_queue">
            <column name="status"/>
            <column name="next_retry_at"/>
            <column name="retry_count"/>
        </createIndex>
        
        <!-- Index for transaction lookup -->
        <createIndex tableName="ghanaemr_nhie_transaction_log" indexName="idx_nhie_txn_transaction_id">
            <column name="transaction_id"/>
        </createIndex>
    </changeSet>
    
    <!--
        NHIE Coverage Cache Table
        Purpose: Cache NHIS eligibility check results to reduce NHIE API calls
        TTL: 24 hours
        Reference: AGENTS.md lines 657-662
    -->
    <changeSet id="ghanaemr-nhie-coverage-cache-1" author="ghana-emr">
        <comment>Create NHIE coverage cache table for NHIS eligibility caching</comment>
        
        <createTable tableName="ghanaemr_nhie_coverage_cache">
            <!-- Primary Key -->
            <column name="id" type="BIGINT" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            
            <!-- NHIS Number (unique - one cache entry per NHIS number) -->
            <column name="nhis_number" type="VARCHAR(10)">
                <constraints nullable="false" unique="true"/>
            </column>
            
            <!-- Coverage Status -->
            <column name="status" type="VARCHAR(20)">
                <constraints nullable="false"/>
            </column>
            
            <!-- Coverage Period -->
            <column name="valid_from" type="DATE">
                <constraints nullable="true"/>
            </column>
            
            <column name="valid_to" type="DATE">
                <constraints nullable="true"/>
            </column>
            
            <!-- FHIR Coverage Resource (full response for reference) -->
            <column name="coverage_json" type="TEXT">
                <constraints nullable="true"/>
            </column>
            
            <!-- Cache Metadata -->
            <column name="cached_at" type="DATETIME">
                <constraints nullable="false"/>
            </column>
            
            <column name="expires_at" type="DATETIME">
                <constraints nullable="false"/>
            </column>
            
            <!-- User who triggered the eligibility check -->
            <column name="creator" type="INT">
                <constraints nullable="false"
                             foreignKeyName="fk_nhie_coverage_creator"
                             referencedTableName="users"
                             referencedColumnNames="user_id"/>
            </column>
        </createTable>
        
        <!-- Index for NHIS number lookup -->
        <createIndex tableName="ghanaemr_nhie_coverage_cache" indexName="idx_nhie_coverage_nhis">
            <column name="nhis_number"/>
        </createIndex>
        
        <!-- Index for expiry cleanup job -->
        <createIndex tableName="ghanaemr_nhie_coverage_cache" indexName="idx_nhie_coverage_expires">
            <column name="expires_at"/>
        </createIndex>
</changeSet>

    <!-- User Roles Seeding -->
    <changeSet id="ghanaemr-roles-1" author="ghana-emr">
        <preConditions onFail="MARK_RAN">
            <sqlCheck expectedResult="0">
                SELECT COUNT(*) FROM role WHERE role IN ('Platform Admin','Facility Admin','Doctor','Nurse','Pharmacist','Records Officer','Cashier','NHIS Officer')
            </sqlCheck>
        </preConditions>
        <comment>Seed core roles for Ghana EMR MVP</comment>
        <sql>
            INSERT IGNORE INTO role (role, description, uuid) VALUES
            ('Platform Admin','Multi-facility oversight, system config','b9b3d4a0-1a30-4a6f-9d3e-100000000001'),
            ('Facility Admin','Per-facility admin and monitoring','b9b3d4a0-1a30-4a6f-9d3e-100000000002'),
            ('Doctor','Clinical role: consultation','b9b3d4a0-1a30-4a6f-9d3e-100000000003'),
            ('Nurse','Clinical role: triage','b9b3d4a0-1a30-4a6f-9d3e-100000000004'),
            ('Pharmacist','Dispense medications','b9b3d4a0-1a30-4a6f-9d3e-100000000005'),
            ('Records Officer','Registration and records','b9b3d4a0-1a30-4a6f-9d3e-100000000006'),
            ('Cashier','Billing and payments','b9b3d4a0-1a30-4a6f-9d3e-100000000007'),
            ('NHIS Officer','NHIS eligibility and claims','b9b3d4a0-1a30-4a6f-9d3e-100000000008');
        </sql>
    </changeSet>

    <!-- Privileges and Role Mappings -->
    <changeSet id="ghanaemr-privileges-1" author="ghana-emr">
        <comment>Define core privileges and assign to roles</comment>
        <sql>
            INSERT IGNORE INTO privilege (privilege, description, uuid) VALUES
            ('ghanaemr.nhie.view','View NHIE status and coverage','c1a0e100-0000-0000-0000-000000000001'),
            ('ghanaemr.nhie.manage','Manage NHIE queue (requeue DLQ)','c1a0e100-0000-0000-0000-000000000002'),
            ('ghanaemr.nhie.sync','Trigger NHIE sync','c1a0e100-0000-0000-0000-000000000003'),
            ('ghanaemr.reports.view','View reports','c1a0e100-0000-0000-0000-000000000004'),
            ('ghanaemr.opd.triage','Record triage','c1a0e100-0000-0000-0000-000000000005'),
            ('ghanaemr.opd.consult','Record consultation','c1a0e100-0000-0000-0000-000000000006'),
            ('ghanaemr.opd.dispense','Record dispense','c1a0e100-0000-0000-0000-000000000007');

            INSERT IGNORE INTO role_privilege (role, privilege) VALUES
            ('Platform Admin','ghanaemr.nhie.view'),
            ('Platform Admin','ghanaemr.nhie.manage'),
            ('Platform Admin','ghanaemr.nhie.sync'),
            ('Platform Admin','ghanaemr.reports.view'),
            ('Platform Admin','ghanaemr.opd.triage'),
            ('Platform Admin','ghanaemr.opd.consult'),
            ('Platform Admin','ghanaemr.opd.dispense'),

            ('Facility Admin','ghanaemr.nhie.view'),
            ('Facility Admin','ghanaemr.nhie.manage'),
            ('Facility Admin','ghanaemr.nhie.sync'),
            ('Facility Admin','ghanaemr.reports.view'),

            ('Doctor','ghanaemr.opd.consult'),
            ('Doctor','ghanaemr.reports.view'),

            ('Nurse','ghanaemr.opd.triage'),

            ('Pharmacist','ghanaemr.opd.dispense'),

            ('Records Officer','ghanaemr.reports.view'),

            ('Cashier','ghanaemr.reports.view'),

            ('NHIS Officer','ghanaemr.reports.view'),
            ('NHIS Officer','ghanaemr.nhie.view');
        </sql>
    </changeSet>

    <!-- Map default admin user to core roles for local dev convenience -->
    <changeSet id="ghanaemr-user-role-seed-1" author="ghana-emr">
        <preConditions onFail="MARK_RAN">
            <sqlCheck expectedResult="1">
                SELECT COUNT(*) FROM users WHERE username='admin'
            </sqlCheck>
        </preConditions>
        <comment>Assign all core roles to admin user for development</comment>
        <sql>
            INSERT IGNORE INTO user_role (user_id, role)
            SELECT u.user_id, r.role FROM users u JOIN role r ON 1=1
            WHERE u.username='admin' AND r.role IN (
                'Platform Admin','Facility Admin','Doctor','Nurse','Pharmacist','Records Officer','Cashier','NHIS Officer'
            );
        </sql>
    </changeSet>

    <!-- Ghana OPD Triage: vital sign concepts (references standard OpenMRS concepts) -->
    <changeSet id="20251102-vitals-concepts" author="ai-worker">
        <comment>Define Ghana OPD triage vital signs metadata (uses standard OpenMRS concepts where available)</comment>
        <!-- Note: The standard OpenMRS CIEL concepts are typically preloaded. We reference standard UUIDs
             instead of inserting duplicates. This changeset remains lightweight and idempotent. -->

        <!-- Vitals Concept Set placeholder (no-op if concepts pre-exist). Left as documentation hook. -->
        <comment>
            Vital concepts:
            - 5085AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA = Systolic blood pressure (mmHg)
            - 5086AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA = Diastolic blood pressure (mmHg)
            - 5088AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA = Body temperature (Â°C)
            - 5089AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA = Weight (kg)
            - 5090AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA = Height (cm)
            - 1343AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA = Body Mass Index (kg/m^2)
        </comment>
    </changeSet>

</databaseChangeLog>
