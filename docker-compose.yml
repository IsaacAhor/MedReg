# version: '3.8'

services:
  mysql:
    image: mysql:5.7
    container_name: medreg-mysql
    restart: unless-stopped
    environment:
      MYSQL_ROOT_PASSWORD: root_password
      MYSQL_DATABASE: openmrs
      MYSQL_USER: openmrs_user
      MYSQL_PASSWORD: openmrs_password
    ports:
      - "3307:3306"
    volumes:
      - mysql_data:/var/lib/mysql
      #- ./mysql-init:/docker-entrypoint-initdb.d
    command: 
        --default-authentication-plugin=mysql_native_password
        --character-set-server=utf8mb4
        --collation-server=utf8mb4_unicode_ci
        --default-storage-engine=InnoDB
        --sql-mode=STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_ENGINE_SUBSTITUTION
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-proot_password"]
      interval: 10s
      timeout: 5s
      retries: 10
    networks:
      - medreg-network

  openmrs:
    image: openmrs/openmrs-reference-application-distro:2.11.0
    container_name: medreg-openmrs
    restart: unless-stopped
    depends_on:
      mysql:
        condition: service_healthy
    environment:
      DB_DATABASE: openmrs
      DB_HOST: mysql
      DB_USERNAME: openmrs_user
      DB_PASSWORD: openmrs_password
      DB_CREATE_TABLES: "true"
      DB_AUTO_UPDATE: "true"
      MODULE_WEB_ADMIN: "true"
    ports:
      - "8080:8080"
    volumes:
      - openmrs_data:/root/.OpenMRS
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/openmrs/"]
      interval: 30s
      timeout: 10s
      retries: 10
      start_period: 300s
    networks:
      - medreg-network

  # NHIE Mock Server (HAPI FHIR JPA Starter)
  # Purpose: Simulate Ghana NHIE endpoints for development and testing
  nhie-mock:
    image: hapiproject/hapi:v7.0.2
    container_name: medreg-nhie-mock
    restart: unless-stopped
    depends_on:
      nhie-mock-db:
        condition: service_healthy
    environment:
      # FHIR Version
      hapi.fhir.fhir_version: R4
      
      # Server Configuration
      hapi.fhir.server_address: http://localhost:8090/fhir
      hapi.fhir.allow_external_references: "true"
      hapi.fhir.allow_placeholder_references: "true"
      
      # Enable CORS for local development
      hapi.fhir.cors.enabled: "true"
      hapi.fhir.cors.allowed_origin: "*"
      
      # Database (PostgreSQL for persistence)
      spring.datasource.url: jdbc:postgresql://nhie-mock-db:5432/hapi
      spring.datasource.username: hapi
      spring.datasource.password: hapi_password
      spring.datasource.driverClassName: org.postgresql.Driver
      spring.jpa.properties.hibernate.dialect: org.hibernate.dialect.PostgreSQLDialect
      
      # Performance tuning
      hapi.fhir.max_page_size: 50
      hapi.fhir.reuse_cached_search_results_millis: 60000
      
      # Subscription support (optional)
      hapi.fhir.subscription.resthook_enabled: "false"
      hapi.fhir.subscription.websocket_enabled: "false"
    ports:
      - "8090:8080"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/fhir/metadata"]
      interval: 30s
      timeout: 10s
      retries: 10
      start_period: 120s
    networks:
      - medreg-network

  # PostgreSQL for NHIE Mock
  nhie-mock-db:
    image: postgres:15-alpine
    container_name: medreg-nhie-mock-db
    restart: unless-stopped
    environment:
      POSTGRES_DB: hapi
      POSTGRES_USER: hapi
      POSTGRES_PASSWORD: hapi_password
    ports:
      - "5433:5432"
    volumes:
      - nhie_mock_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U hapi"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - medreg-network

volumes:
  mysql_data:
    driver: local
  openmrs_data:
    driver: local
  nhie_mock_data:
    driver: local

networks:
  medreg-network:
    driver: bridge
